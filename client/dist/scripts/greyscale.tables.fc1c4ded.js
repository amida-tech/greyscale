"use strict";angular.module("greyscale.tables",[]).config(function(){}),angular.module("greyscale.tables").factory("greyscaleProjectProductsTbl",["$q","_","greyscaleProjectApi","greyscaleProductApi","greyscaleModalsSrv","greyscaleUtilsSrv","greyscaleProductWorkflowApi","greyscaleGlobals","$state","inform","i18n",function(a,b,c,d,e,f,g,h,i,j,k){function l(){return M.dataFilter.projectId}function m(){var b=l();if(b){var d={surveys:c.surveysList(b),products:c.productsList(b)};return a.all(d).then(function(a){return I.surveys=a.surveys,a.products})}return a.reject()}function n(){return h.productStates}function o(){return I.surveys}function p(a){var b="editing";w(a).then(function(a){var b=angular.copy(M);return e.editRec(a,b)}).then(function(a){return a.id?d.update(a):(b="adding",a.projectId=l(),a.matrixId=4,d.add(a))}).then(r)["catch"](function(a){return v(a,b)})}function q(a){e.confirm({message:H+"DELETE_CONFIRM",product:a,okType:"danger",okText:"COMMON.DELETE"}).then(function(){d["delete"](a.id).then(r)["catch"](function(a){return v(a,"delete")})})}function r(){M.tableParams.reload()}function s(a){return e.productUoas(a)}function t(a){e.productWorkflow(a).then(function(b){return x(a,b)}).then(r)}function u(a){i.go("projects.setup.tasks",{productId:a.id,product:a})}function v(a,b){var c=M.formTitle+" "+b+" error";f.errorMsg(a,c)}function w(b){if(!b||!b.id)return a.when(b);var c=angular.copy(b),e={uoas:d.product(b.id).uoasList(),tasks:d.product(b.id).tasksList()};return b.workflow&&b.workflow.id&&(e.workflowSteps=g.workflow(b.workflow.id).stepsList()),a.all(e).then(function(a){return angular.extend(c,a),c})}function x(c,d){var e=a.when(d.workflow);return b.isEqual(d.workflow,c.workflow)||(e=y(d.workflow)),e.then(function(a){return z(a.id,d.steps)})}function y(b){return b.id?g.update(b).then(function(){return a.when(b)}):g.add(b).then(function(c){return b.id=c.id,a.when(b)})}function z(a,b){return g.workflow(a).stepsListUpdate(b)}function A(a){return!(a.uoas&&a.uoas.length&&a.surveyId&&a.workflowSteps&&a.workflowSteps.length&&a.tasks&&a.tasks.length)}function B(a,b){return a.id!==J.STATUS_PLANNING&&a.id!==J.STATUS_CANCELLED&&A(b)}function C(a){if(a.id&&A(a)){var b=k.translate(H+"PLANNING_NOT_FINISH");return b}}function D(a){return K[a.status]?K[a.status]:""}function E(a){var b,c;return a.status===J.STATUS_SUSPENDED?b="START":a.status===J.STATUS_STARTED&&(b="PAUSE"),b&&(c=H+b+"_PRODUCT"),c}function F(a){var b,c="changing status",e=a.status;if(e===J.STATUS_STARTED?b=J.STATUS_SUSPENDED:e===J.STATUS_SUSPENDED&&(b=J.STATUS_STARTED),void 0!==b){var f=angular.copy(a);f.status=b,d.update(f).then(r)["catch"](function(a){return G(a,c)})}}function G(a,b){var c=M.formTitle+" "+b+" error";f.errorMsg(a,c)}var H="PRODUCTS.TABLE.",I={surveys:[]},J={STATUS_PLANNING:0,STATUS_STARTED:1,STATUS_SUSPENDED:2,STATUS_CANCELLED:4},K={};K[J.STATUS_STARTED]="fa-pause",K[J.STATUS_SUSPENDED]="fa-play";var L=[{field:"title",title:H+"TITLE",show:!0,sortable:"title",dataRequired:!0},{field:"description",title:H+"DESCRIPTION",show:!0,dataRequired:!0,dataFormat:"textarea"},{field:"surveyId",title:H+"SURVEY",show:!0,sortable:"surveyId",dataFormat:"option",cellTemplate:'<span ng-if="option.id">{{option.title}} <small>(<span ng-show="option.isDraft" translate="SURVEYS.IS_DRAFT"></span><span ng-show="!option.isDraft" translate="SURVEYS.IS_COMPLETE"></span>)</small></span>',dataPlaceholder:H+"SELECT_SURVEY",dataRequired:!0,dataSet:{getData:o,keyField:"id",valField:"title"},link:{state:"projects.setup.surveys.edit({projectId: item.projectId, surveyId: item.surveyId})"}},{field:"workflow.name",sortable:"workflow.name",title:H+"WORKFLOW",show:!0,cellTemplate:'{{cell}}<span ng-if="!cell" class="action" translate="'+H+'CREATE_WORKFLOW"></span>',link:{handler:t},dataHide:!0},{show:!0,dataFormat:"action",dataHide:!0,actions:[{getIcon:D,getTooltip:E,"class":"info",handler:F}]},{field:"status",show:!0,sortable:"status",title:H+"STATUS",dataFormat:"option",dataNoEmptyOption:!0,dataRequired:!0,dataSet:{getData:n,keyField:"id",valField:"name",getDisabled:B}},{title:H+"SETTINGS",show:!0,dataFormat:"action",dataHide:!0,textLeft:!0,actions:[{title:H+"UOAS","class":"info",handler:s},{title:H+"TASKS","class":"info",handler:u}]},{show:!0,dataFormat:"action",actions:[{icon:"fa-pencil",tooltip:"COMMON.EDIT",handler:p},{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:q}]}],M={title:"",cols:L,sorting:{id:"asc"},dataPromise:m,dataFilter:{},formTitle:H+"PRODUCT",formWarning:C,add:{handler:p}};return M}]),angular.module("greyscale.tables").factory("greyscaleProjectSurveysTbl",["$q","$state","greyscaleSurveyApi","greyscaleProjectApi","greyscaleModalsSrv","greyscaleUtilsSrv",function(a,b,c,d,e,f){function g(){return o.dataFilter.projectId}function h(){var b=g();return b?d.surveysList(b):a.reject()}function i(){console.log("reload"),o.tableParams.reload()}function j(a){b.go("projects.setup.surveys.edit",{surveyId:a?a.id:"new",projectId:g()})}function k(a){e.confirm({message:m+"DELETE_CONFIRM",survey:a,okType:"danger",okText:"COMMON.DELETE"}).then(function(){c["delete"](a).then(i)["catch"](function(a){f.errorMsg(a,"Survey delete error")})})}function l(a){b.go("survey",{surveyId:a.id})}var m="SURVEYS.",n=[{field:"title",title:m+"NAME",show:!0,sortable:"title",dataRequired:!0,dataFormat:"text"},{field:"description",title:m+"DESCRIPTION",show:!0,dataRequired:!1,dataFormat:"text"},{field:"isDraft",title:m+"STATUS",show:!0,cellTemplate:'<span ng-if="cell" class="text-warning" translate="SURVEYS.IS_DRAFT"></span><span ng-if="!cell" class="text-success" translate="SURVEYS.IS_COMPLETE"></span>'},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-eye",tooltip:"COMMON.VIEW",handler:l},{icon:"fa-pencil",tooltip:"COMMON.EDIT",handler:j},{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:k}]}],o={cols:n,sorting:{id:"asc"},dataPromise:h,dataFilter:{},formTitle:m+"ITEM",add:{handler:j}};return o}]),angular.module("greyscale.tables").factory("greyscaleUsersTbl",["_","$q","greyscaleModalsSrv","greyscaleUserApi","greyscaleUtilsSrv","inform","i18n","greyscaleProfileSrv","greyscaleGlobals","greyscaleRolesSrv","greyscaleNotificationApi","greyscaleGroupApi",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){return D.roles}function n(){return i.notifyLevels}function o(b){return a.map(a.filter(D.groups,function(a){return~b.usergroupId.indexOf(a.id)}),"title").join(", ")}function p(a){c.confirm({message:C+"DELETE_CONFIRM",user:a,okType:"danger",okText:"COMMON.DELETE"}).then(function(){d["delete"](a.id).then(w)["catch"](function(a){A(a,"deleting")})})}function q(a){return a.id!==D.profile.id}function r(a){c.sendNotification(a)}function s(a){c.changePassword(a)}function t(a){var b="adding";return c.editRec(a,F).then(function(a){return a.password&&delete a.password,a.id?(b="editing",d.update(a)):(a.organizationId=x(),d.inviteUser(a))}).then(w)["catch"](function(a){A(a,b)})}function u(a){k.resendUserInvite(a.id).then(function(){f.add(g.translate(C+"RESEND_ACTIVATION_DONE"),{type:"success"})})["catch"](function(a){e.errorMsg(a,"Resend Activation")})}function v(a){c.userGroups(a).then(function(b){a.usergroupId=b,d.update(a)})}function w(){F.tableParams.reload()}function x(){return F.dataFilter.organizationId}function y(){var c=x();return c?h.getProfile().then(function(f){var g={roles:j(),users:d.list(),groups:l.list(c)};return D.profile=f,b.all(g).then(function(b){var c=a.filter(b.roles,function(a){return a.isSystem&&a.id!==i.userRoles.superAdmin.id&&a.id>=D.profile.roleID});return D.roles=z(c),D.groups=b.groups,e.prepareFields(b.users,E),D.users=b.users,b.users})})["catch"](A):b.reject("400")}function z(a){return angular.forEach(a,function(a){a.title=g.translate("GLOBALS.ROLES."+a.name.toUpperCase())}),a}function A(a,b){var c=F.formTitle;b&&(c+=" "+b),c+=" error",e.errorMsg(a,c)}function B(){return!!F.profileMode}var C="USERS.",D={users:[]},E=[{field:"id",title:"ID",show:!1,sortable:"id",dataReadOnly:"both",dataHide:B},{field:"email",title:C+"EMAIL",show:!1,sortable:"email",dataRequired:!0,dataValidate:["email",{unique:{storage:D,dict:"users",field:"email",caseSensitive:!1}}]},{field:"firstName",title:C+"FIRST_NAME",show:!0,sortable:"firstName",dataRequired:!0},{field:"lastName",title:C+"LAST_NAME",show:!0,sortable:"lastName"},{field:"roleID",title:C+"ROLE",dataFormat:"option",dataNoEmptyOption:!0,dataSet:{getData:m,keyField:"id",valField:"title"}},{field:"lastActive",title:C+"LAST_ACTIVE",show:!0,sortable:"lastActive",dataReadOnly:"both",cellTemplate:'<span ng-hide="cell" translate="USERS.NOT_LOGGED"></span>{{cell|date:\'medium\'}}'},{field:"isActive",title:C+"IS_ACTIVE",show:!0,textCenter:!0,sortable:"isActive",dataFormat:"boolean",dataReadOnly:"new"},{field:"isAnonymous",title:C+"ANONYMOUS",show:!0,textCenter:!0,sortable:"isAnonymous",dataFormat:"boolean"},{show:!0,title:C+"GROUPS",cellClass:"col-sm-2",dataReadOnly:"both",dataHide:!0,cellTemplate:'<small>{{ext.getGroups(row)}}</small><small class="text-muted" ng-hide="row.usergroupId.length" translate="'+C+'NO_GROUPS"></small> <a ng-show="widgetCell" class="action" ng-click="ext.editGroups(row); $event.stopPropagation()"><i class="fa fa-pencil"></i></a>',cellTemplateExtData:{getGroups:o,editGroups:v}},{title:"",show:!1,dataHide:!0,cellTemplate:'<span ng-show="!row.isActive"><a ng-click="ext.resendActivation(row)" class="btn btn-primary" translate="'+C+'RESEND_ACTIVATION"></a></span>',cellTemplateExtData:{resendActivation:u}},{title:"COMMON.SEND_MESSAGE",viewHide:!0,textCenter:!0,cellTemplate:'<a ng-click="ext.sendMessageTo(row); $event.stopPropagation()" class="action">       <i ng-if="ext.anotherUser(row)" class="fa fa-envelope"></i>   </a>',dataHide:!0,cellTemplateExtData:{anotherUser:q,sendMessageTo:r}},{field:"notifyLevel",title:C+"NOTIFY_LEVEL",dataFormat:"option",dataNoEmptyOption:!0,dataSet:{getData:n,keyField:"value",valField:"name"}},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-pencil",tooltip:"COMMON.EDIT",handler:t},{icon:"fa-lock",tooltip:C+"CHANGE_PASSWORD",handler:s},{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:p}]}],F={dataFilter:{},formTitle:C+"USER",cols:E,dataPromise:y,selectable:!0,sorting:{created:"desc"},add:{handler:t}};return F}]),angular.module("greyscale.tables").factory("greyscaleUoasTbl",["$q","greyscaleGlobals","greyscaleUtilsSrv","greyscaleProfileSrv","greyscaleModalsSrv","greyscaleLanguageApi","greyscaleUoaApi","greyscaleUoaTypeApi","$rootScope",function(a,b,c,d,e,f,g,h,i){function j(){i.$broadcast("update-uoas",{uoas:v.uoas})}function k(a){var b="editing";return g.get(a).then(function(a){return e.editRec(a,x)}).then(function(a){return g.update(a)}).then(s)["catch"](function(a){return t(a,b)})}function l(){var a="adding";return e.editRec(null,x).then(function(a){return g.add(a)}).then(s)["catch"](function(b){return t(b,a)})}function m(){return d.getProfile().then(function(b){var d={uoas:g.list(),uoaTypes:h.list(),languages:f.list()};return a.all(d).then(function(a){for(var b=0;b<a.uoas.length;b++)c.prepareFields(a.uoas,w);return v.languages=a.languages,v.uoaTypes=a.uoaTypes,v.uoas=a.uoas,a.uoas})})}function n(a){a&&(v.uoaTypes=a)}function o(a){e.confirm({message:u+"DELETE_CONFIRM",uoa:a,okType:"danger",okText:"COMMON.DELETE"}).then(function(){g["delete"](a.id).then(s)["catch"](function(a){t(a,"deleting")})})}function p(){return v.visibility}function q(){return v.status}function r(){return v.uoaTypes}function s(){x.tableParams.reload()}function t(a,b){var d=x.formTitle+" "+b+" error";c.errorMsg(a,d)}var u="UOAS.",v={languages:[],uoaTypes:[],visibility:b.uoaVisibility,status:b.uoaStatus},w=[{field:"id",title:"ID",show:!0,sortable:"id",dataFormat:"text",dataRequired:!0,dataReadOnly:"both"},{field:"name",title:u+"NAME",show:!0,sortable:"name",dataFormat:"text",dataRequired:!0},{field:"description",title:u+"DESCRIPTION",show:!0,dataFormat:"text",dataRequired:!0},{field:"shortName",title:u+"SHORT_NAME",show:!0,dataFormat:"text",dataRequired:!0,sortable:"shortName"},{field:"unitOfAnalysisType",title:u+"TYPE",show:!0,sortable:"unitOfAnalysisType",dataFormat:"option",dataRequired:!0,dataSet:{getData:r,keyField:"id",valField:"name"}},{field:"visibility",title:u+"VISIBILITY",show:!0,sortable:"visibility",dataFormat:"option",dataRequired:!0,dataSet:{getData:p,keyField:"id",valField:"name"}},{field:"status",title:u+"STATUS",show:!0,sortable:"status",dataFormat:"option",dataRequired:!0,dataSet:{getData:q,keyField:"id",valField:"name"}},{field:"created",title:u+"CREATED",show:!0,dataFormat:"date",sortable:"created",dataRequired:!0,dataReadOnly:"both"},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-pencil",tooltip:"COMMON.EDIT",handler:k},{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:o}]}],x={title:u+"UOAS",formTitle:u+"UOA",icon:"fa-table",sorting:{id:"asc"},cols:w,update:{uoaTypes:n},dataPromise:m,add:{handler:l},onReload:j};return x}]),angular.module("greyscale.tables").factory("greyscaleUoasImportTbl",["$q","greyscaleUoaTypeApi","greyscaleGlobals",function(a,b,c){function d(){return h.status}function e(){return h.visibility}function f(){return h.uoaTypes}var g="IMPORT.UOAS.",h={visibility:c.uoaVisibility,status:c.uoaStatus};b.list().then(function(a){h.uoaTypes=a});var i=[{field:"name",show:!0,sortable:"name",title:g+"NAME"},{field:"description",show:!0,sortable:"description",title:g+"DESCRIPTION"},{field:"shortName",show:!0,sortable:"shortName",title:g+"SHORT_NAME"},{field:"ISO",show:!0,sortable:"ISO",title:g+"ISO"},{field:"ISO2",show:!0,sortable:"ISO2",title:g+"ISO2"},{field:"nameISO",show:!0,sortable:"nameISO",title:g+"NAMEISO"},{field:"unitOfAnalysisType",show:!0,sortable:"unitOfAnalysisType",title:g+"UOA_TYPE",dataFormat:"option",dataSet:{getData:f,keyField:"id",valField:"name"}},{field:"visibility",show:!0,sortable:"visibility",title:g+"VISIBILITY",dataFormat:"option",dataSet:{getData:e,keyField:"id",valField:"name"}},{field:"status",show:!0,sortable:"status",title:g+"STATUS",dataFormat:"option",dataSet:{getData:d,keyField:"id",valField:"name"}},{sortable:"message",title:g+"RESULT",cellTemplate:"<div ng-class=\"{'text-danger':(row.parse_status == 'skipped'), 'text-success':(row.parse_status == 'Ok')}\">{{row.message}}<div ng-repeat=\"message in row.messages\">{{message}}</div></div>"}],j={title:g+"RESULTS_TITLE",icon:"fa-upload",cols:i};return j}]),angular.module("greyscale.tables").factory("greyscaleUoasFilterTbl",["$q","greyscaleGlobals","greyscaleUtilsSrv","greyscaleProfileSrv","greyscaleModalsSrv","greyscaleLanguageApi","greyscaleUoaApi","greyscaleUoaTypeApi",function(a,b,c,d,e,f,g,h){function i(a){var b=p.dataFilter[a];return b&&b.length?b.join("|"):null}function j(){return d.getProfile().then(function(b){var d={uoas:k(),uoaTypes:h.list(),languages:f.list()};return a.all(d).then(function(a){for(var b=0;b<a.uoas.length;b++)c.prepareFields(a.uoas,o);return n.languages=a.languages,n.uoaTypes=a.uoaTypes,a.uoas})})}function k(){var a,b=i("typeId"),c=i("tagId");return b&&c?(a={unitOfAnalysisType:b,tagId:c},g.list(a)):g.list()}function l(){return n.uoaTypes}var m="UOAS_FILTER.",n={languages:[],uoaTypes:[],visibility:b.uoaVisibility,status:b.uoaStatus},o=[{field:"name",title:m+"NAME",show:!0,sortable:"name",dataFormat:"text",dataRequired:!0},{field:"description",title:m+"DESCRIPTION",show:!0,dataFormat:"text",dataRequired:!0},{field:"shortName",title:m+"SHORT_NAME",show:!0,dataFormat:"text",dataRequired:!0,sortable:"shortName"},{field:"unitOfAnalysisType",title:m+"TYPE",show:!0,sortable:"unitOfAnalysisType",dataFormat:"option",dataRequired:!0,dataSet:{getData:l,keyField:"id",valField:"name"}},{show:!0,multiselect:!0}],p={title:m+"TABLE_TITLE",icon:"fa-table",sorting:{id:"asc"},cols:o,dataPromise:j,multiselect:{},dataFilter:{}};return p}]),angular.module("greyscale.tables").factory("greyscaleUoaTypesTbl",["$q","greyscaleUtilsSrv","greyscaleProfileSrv","greyscaleModalsSrv","greyscaleUoaTypeApi","greyscaleLanguageApi","$rootScope",function(a,b,c,d,e,f,g){function h(a){var b="editing";return e.get(a).then(function(a){return d.editRec(a,s)}).then(function(a){return e.update(a)}).then(n)["catch"](function(a){return o(a,b)})}function i(){var a="adding";return d.editRec(null,s).then(function(a){return e.add(a)}).then(n)["catch"](function(b){return o(b,a)})}function j(){g.$broadcast("update-uoaTypes",{uoaTypes:q.uoaTypes})}function k(a){d.confirm({message:p+"DELETE_CONFIRM_TYPE",uoaType:a,okType:"danger",okText:"COMMON.DELETE"}).then(function(){e["delete"](a.id).then(n)["catch"](function(a){o(a,"deleting")})})}function l(){return c.getProfile().then(function(c){var d={uoaTypes:e.list(),languages:f.list()};return a.all(d).then(function(a){for(var c=0;c<a.uoaTypes.length;c++)b.prepareFields(a.uoaTypes,r);return q.languages=a.languages,q.uoaTypes=a.uoaTypes,a.uoaTypes})})}function m(){return q.languages}function n(){s.tableParams.reload()}function o(a,c){var d=s.formTitle+" "+c+" error";b.errorMsg(a,d)}var p="UOAS.",q={languages:[]},r=[{field:"id",title:"ID",show:!0,sortable:"id",dataFormat:"text",dataReadOnly:!0},{field:"name",title:p+"TYPE_NAME",show:!0,sortable:"name",dataFormat:"text",dataRequired:!0},{field:"description",title:p+"TYPE_DESCRIPTION",show:!0,dataFormat:"text",dataRequired:!0},{field:"langId",title:"COMMON.ORIGINAL_LANGUAGE",show:!0,sortable:"langId",dataFormat:"option",dataReadOnly:"edit",dataRequired:!0,dataSet:{getData:m,keyField:"id",valField:"name"}},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-pencil",tooltip:"COMMON.EDIT",handler:h},{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:k}]}],s={title:p+"UNIT_TYPES",formTitle:p+"UNIT_TYPE",icon:"fa-table",sorting:{id:"asc"},cols:r,dataPromise:l,add:{handler:i},onReload:j};return s}]),angular.module("greyscale.tables").factory("greyscaleUoaTypesFilterTbl",["$q","greyscaleUtilsSrv","greyscaleProfileSrv","greyscaleModalsSrv","greyscaleUoaTypeApi","greyscaleLanguageApi",function(a,b,c,d,e,f){function g(){return c.getProfile().then(function(c){var d={uoaTypes:e.list(),languages:f.list()};return a.all(d).then(function(a){for(var c=0;c<a.uoaTypes.length;c++)b.prepareFields(a.uoaTypes,j);return i.languages=a.languages,a.uoaTypes})})}function h(){return i.languages}var i={languages:[]},j=[{field:"name",title:"Name",show:!0,sortable:"name",dataFormat:"text",dataRequired:!0},{field:"description",title:"Description",show:!0,dataFormat:"text",dataRequired:!0},{field:"langId",title:"Original language",show:!0,sortable:"langId",dataFormat:"option",dataReadOnly:"edit",dataRequired:!0,dataSet:{getData:h,keyField:"id",valField:"name"}},{show:!0,multiselect:!0}],k={title:"Unit Types",icon:"fa-table",sorting:{id:"asc"},cols:j,dataPromise:g,multiselect:{}};return k}]),angular.module("greyscale.tables").factory("greyscaleUoaClassTypesFilter",["$q","greyscaleUtilsSrv","greyscaleProfileSrv","greyscaleModalsSrv","greyscaleLanguageApi","greyscaleUoaClassTypeApi",function(a,b,c,d,e,f){function g(){return c.getProfile().then(function(c){var d={uoaClassTypes:f.list(),languages:e.list()};return a.all(d).then(function(a){for(var c=0;c<a.uoaClassTypes.length;c++)b.prepareFields(a.uoaClassTypes,j);return i.languages=a.languages,a.uoaClassTypes})})}function h(){return i.languages}var i={languages:[]},j=[{field:"name",title:"Name",show:!0,sortable:"name",dataFormat:"text",dataRequired:!0},{field:"description",title:"Description",show:!0,dataFormat:"text"},{field:"langId",title:"Original language",show:!0,sortable:"langId",dataFormat:"option",dataReadOnly:"edit",dataRequired:!0,dataSet:{getData:h,keyField:"id",valField:"name"}},{show:!0,multiselect:!0}],k={title:"Tag Classification Types",icon:"fa-table",sorting:{id:"asc"},cols:j,dataPromise:g,multiselect:{}};return k}]),angular.module("greyscale.tables").factory("greyscaleUoaTagsFilter",["$q","greyscaleUtilsSrv","greyscaleProfileSrv","greyscaleModalsSrv","greyscaleLanguageApi","greyscaleUoaTagApi","greyscaleUoaClassTypeApi",function(a,b,c,d,e,f,g){function h(a){var b=n.dataFilter[a];return b&&b.length?b.join("|"):null}function i(){return c.getProfile().then(function(c){var d={uoaTags:j(),uoaClassTypes:g.list(),languages:e.list()};return a.all(d).then(function(a){for(var c=0;c<a.uoaTags.length;c++)b.prepareFields(a.uoaTags,m);return l.languages=a.languages,l.uoaClassTypes=a.uoaClassTypes,a.uoaTags})})}function j(){var b,c=h("classTypeId");return c?(b={classTypeId:c},f.list(b)):a.when([])}function k(){return l.uoaClassTypes}var l={languages:[],uoaClassTypes:[]},m=[{field:"name",title:"Name",show:!0,sortable:"name",dataFormat:"text",dataRequired:!0},{field:"description",title:"Description",show:!0,dataFormat:"text",dataRequired:!0},{field:"classTypeId",title:"Classification Type",show:!0,sortable:"classTypeId",dataFormat:"option",dataRequired:!0,dataSet:{getData:k,keyField:"id",valField:"name"}},{show:!0,multiselect:!0}],n={dataFilter:{},title:"Tags",icon:"fa-table",sorting:{id:"asc"},cols:m,dataPromise:i,multiselect:{}};return n}]),angular.module("greyscale.tables").factory("greyscaleUoaTagsTbl",["$q","greyscaleUtilsSrv","greyscaleProfileSrv","greyscaleModalsSrv","greyscaleLanguageApi","greyscaleUoaTagApi","greyscaleUoaClassTypeApi","$rootScope",function(a,b,c,d,e,f,g,h){function i(){h.$broadcast("update-uoaTags",{uoaTags:s.uoaTags})}function j(a){a&&(s.uoaClassTypes=a)}function k(a){var b="editing";return f.get(a).then(function(a){return d.editRec(a,u)}).then(function(a){return f.update(a)}).then(p)["catch"](function(a){return q(a,b)})}function l(){var a="adding";return d.editRec(null,u).then(function(a){return f.add(a)}).then(p)["catch"](function(b){return q(b,a)})}function m(a){d.confirm({message:r+"DELETE_CONFIRM",tag:a,okType:"danger",okText:"COMMON.DELETE"}).then(function(){f["delete"](a.id).then(p)["catch"](function(a){q(a,"deleting")})})}function n(){return c.getProfile().then(function(c){var d={uoaTags:f.list(),uoaClassTypes:g.list(),languages:e.list()};return a.all(d).then(function(a){for(var c=0;c<a.uoaTags.length;c++)b.prepareFields(a.uoaTags,t);return s.languages=a.languages,s.uoaClassTypes=a.uoaClassTypes,s.uoaTags=a.uoaTags,a.uoaTags})})}function o(){return s.uoaClassTypes}function p(){u.tableParams.reload()}function q(a,c){var d=u.formTitle+" "+c+" error";b.errorMsg(a,d)}var r="UOA_TAGS.",s={languages:[],uoaClassTypes:[]},t=[{field:"id",title:"ID",show:!0,sortable:"id",dataFormat:"text",dataRequired:!0,dataReadOnly:"both"},{field:"name",title:r+"NAME",show:!0,sortable:"name",dataFormat:"text",dataRequired:!0},{field:"description",title:r+"DESCRIPTION",show:!0,dataFormat:"text",dataRequired:!0},{field:"classTypeId",title:r+"CLASSIFICATION_TYPE",show:!0,sortable:"classTypeId",dataFormat:"option",dataRequired:!0,dataSet:{getData:o,keyField:"id",valField:"name"}},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-pencil",tooltip:"COMMON.EDIT",handler:k},{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:m}]}],u={title:r+"TAGS",formTitle:r+"TAG",icon:"fa-table",sorting:{id:"asc"},cols:t,dataPromise:n,add:{handler:l},update:{uoaClassTypes:j},onReload:i};return u}]),angular.module("greyscale.tables").factory("greyscaleUoaTagLinksTbl",["_","$q","greyscaleUtilsSrv","greyscaleProfileSrv","greyscaleModalsSrv","greyscaleUoaApi","greyscaleUoaTagApi","greyscaleUoaClassTypeApi","greyscaleUoaTagLinkApi",function(a,b,c,d,e,f,g,h,i){function j(a){a&&(t.uoaTags=a)}function k(a){a&&(t.uoas=a)}function l(){var a="adding";return e.editRec(null,v).then(function(a){return i.add(a)}).then(q)["catch"](function(b){return r(b,a)})}function m(b){var c=a.find(t.uoas,{id:b.uoaId}),d=a.find(t.uoaTags,{id:b.uoaTagId});e.confirm({message:s+"DELETE_CONFIRM_UOA_TAG_LINK",uoa:c,tag:d,okType:"danger",okText:"COMMON.DELETE"}).then(function(){i["delete"](b.id).then(q)["catch"](function(a){r(a,"deleting")})})}function n(){var a={uoaTagLinks:i.list(v.query),uoas:f.list(),uoaTags:g.list(),uoaClassTypes:h.list()};return b.all(a).then(function(a){for(var b=0;b<a.uoaTagLinks.length;b++)c.prepareFields(a.uoaTagLinks,u);return t.uoas=a.uoas,t.uoaTags=a.uoaTags,t.uoaClassTypes=a.uoaClassTypes,a.uoaTagLinks})}function o(){return t.uoas}function p(){return t.uoaTags}function q(){v.tableParams.reload()}function r(a,b){var d=v.formTitle+" "+b+" error";c.errorMsg(a,d)}var s="UOAS.",t={uoas:[],uoaTags:[],uoaClassType:[]},u=[{field:"id",title:"ID",show:!0,sortable:"id",dataFormat:"text",dataRequired:!0,dataReadOnly:"both"},{field:"uoaId",title:s+"UOA",show:!0,sortable:"uoaId",dataFormat:"option",dataRequired:!0,dataSet:{getData:o,keyField:"id",valField:"name"}},{field:"uoaTagId",title:s+"TAG",show:!0,sortable:"uoaTagId",dataFormat:"option",dataRequired:!0,dataSet:{getData:p,keyField:"id",valField:"name"}},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:m}]}],v={title:s+"UOA_TAG_LINKS",formTitle:s+"UOA_TAG_LINK",icon:"fa-table",sorting:{id:"asc"},cols:u,dataPromise:n,add:{handler:l},query:{},update:{uoaTags:j,uoas:k}};return v}]),angular.module("greyscale.tables").factory("greyscaleUoaClassTypesTbl",["$q","greyscaleUtilsSrv","greyscaleProfileSrv","greyscaleModalsSrv","greyscaleLanguageApi","greyscaleUoaClassTypeApi","$rootScope",function(a,b,c,d,e,f,g){function h(){g.$broadcast("update-uoaClassTypes",{uoaClassTypes:q.uoaClassTypes})}function i(a){var b="editing";return f.get(a).then(function(a){return d.editRec(a,s)}).then(function(a){return f.update(a)}).then(n)["catch"](function(a){return o(a,b)})}function j(a){var b="adding";return d.editRec(a,s).then(function(a){return f.add(a)}).then(n)["catch"](function(a){return o(a,b)})}function k(a){d.confirm({message:p+"DELETE_CONFIRM_TYPE",tagType:a,okType:"danger",okText:"COMMON.DELETE"}).then(function(){f["delete"](a.id).then(n)["catch"](function(a){o(a,"deleting")})})}function l(){return c.getProfile().then(function(c){var d={uoaClassTypes:f.list(),languages:e.list()};return a.all(d).then(function(a){for(var c=0;c<a.uoaClassTypes.length;c++)b.prepareFields(a.uoaClassTypes,r);return q.languages=a.languages,q.uoaClassTypes=a.uoaClassTypes,a.uoaClassTypes})})}function m(){return q.languages}function n(){s.tableParams.reload()}function o(a,c){var d=s.formTitle+" "+c+" error";b.errorMsg(a,d)}var p="UOA_TAGS.",q={languages:[]},r=[{field:"id",title:"ID",show:!0,sortable:"id",dataFormat:"text",dataReadOnly:!0},{field:"name",title:p+"TYPE_NAME",show:!0,sortable:"name",dataFormat:"text",dataRequired:!0},{field:"description",title:p+"TYPE_DESCRIPTION",show:!0,dataFormat:"text"},{field:"langId",title:"COMMON.ORIGINAL_LANGUAGE",show:!0,sortable:"langId",dataFormat:"option",dataReadOnly:"edit",dataRequired:!0,dataSet:{getData:m,keyField:"id",valField:"name"}},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-pencil",tooltip:"COMMON.EDIT",handler:i},{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:k}]}],s={title:p+"TAG_TYPES",formTitle:p+"TAG_TYPE",icon:"fa-table",sorting:{id:"asc"},cols:r,dataPromise:l,add:{handler:j},onReload:h};return s}]),angular.module("greyscale.tables").factory("greyscaleRolesTbl",["greyscaleRoleApi",function(a){var b="ROLES.",c=function(){return a.list()};return{title:b+"ROLES",icon:"fa-users",cols:[{field:"id",title:"ID",show:!0,sortable:"id"},{field:"name",title:b+"NAME",show:!0,sortable:"name"},{field:"isSystem",title:b+"SYSTEM_ROLE",show:!0,sortable:"isSystem",dataFormat:"boolean"}],sorting:{id:"asc"},dataPromise:c,selectable:!0}}]),angular.module("greyscale.tables").factory("greyscaleRightsTbl",["$q","greyscaleRightApi","greyscaleModalsSrv","greyscaleEntityTypeApi","greyscaleUtilsSrv",function(a,b,c,d,e){function f(){var c={rights:b.list(),eTypes:d.list({fields:"id,name"})};return a.all(c).then(function(a){return a.eTypes.unshift({id:null,name:""}),m.entityTypes=a.eTypes,e.prepareFields(a.rights,n),a.rights})}function g(){return m.entityTypes}function h(a){var d="adding";return c.editRec(a,o).then(function(a){return delete a.entityType,a.id?(d="editing",b.update(a)):b.add(a)}).then(i)["catch"](function(a){k(a,d)})}function i(){o.tableParams.reload()}function j(a){c.confirm({message:l+"DELETE_CONFIRM",right:a,okType:"danger",okText:"COMMON.DELETE"}).then(function(){b["delete"](a.id).then(i)["catch"](function(a){k(a,"deleting")})})}function k(a,b){var c=o.formTitle+" "+b+" error";e.errorMsg(a,c)}var l="RIGHTS.",m={entityTypes:[]},n=[{field:"id",title:"ID",show:!1,sortable:"id",dataFormat:"text",dataReadOnly:"both"},{field:"action",title:l+"ACTION",show:!0,sortable:"action"},{field:"description",title:l+"DESCRIPTION",show:!0,sortable:!1,dataFromat:"textarea"},{field:"essenceId",title:l+"ENTITY_TYPE",show:!0,sortable:!1,dataFormat:"option",dataSet:{getData:g,keyField:"id",valField:"name"}},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-pencil",tooltip:"COMMON.EDIT",handler:h},{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:j}]}],o={formTitle:l+"RIGHT",title:l+"RIGHTS",icon:"fa-tasks",cols:n,dataPromise:f,add:{handler:h}};return o}]),angular.module("greyscale.tables").factory("greyscaleRoleRightsTbl",["$q","greyscaleRightApi","greyscaleRoleApi","greyscaleEntityTypeApi","greyscaleModalsSrv","greyscaleUtilsSrv",function(a,b,c,d,e,f){function g(a){var b=s.dataFilter.role;b&&e.confirm({message:p+"DELETE_CONFIRM",role:b,roleRight:a,okType:"danger",okText:"COMMON.DELETE"}).then(function(){c.delRight(b.id,a.id).then(k)["catch"](function(a){o(a,"deleting")})})}function h(){var a=s.dataFilter.role;if(a)return e.addRoleRight({right:null},{rights:i(),role:a}).then(function(b){return c.addRight(a.id,b.id)}).then(k)["catch"](function(a){o(a,"adding")})}function i(){return q.rights}function j(){return q.entityTypes}function k(){s.tableParams.reload()}function l(){var b=s.dataFilter.role;return b?c.listRights(b.id).then(m):a.when([])}function m(c){var e={};return q.rights||(e.rights=b.list(),e.entityTypes=d.list({fields:"id,name"})),a.all(e).then(function(a){return a.rights&&(q.entityTypes=a.entityTypes,q.rights=n(a.rights)),c})}function n(a){for(var b=j(),c=0;c<a.length;c++)a[c].entityType=f.decode(b,"id",a[c].essenceId,"name");return a}function o(a,b){var c=s.formTitle;b&&(c+=" "+b),c+=" error",f.errorMsg(a,c)}var p="ROLE_RIGHTS.",q={rights:null,entityTypes:null},r=[{field:"id",title:"ID",show:!1,sortable:"id"},{field:"action",title:p+"ACTION",show:!0,sortable:"action"},{field:"description",title:p+"DESCRIPTION",show:!0,sortable:!1},{field:"essenceId",title:p+"ENTITY_TYPE",show:!0,sortable:"essenceId",dataFormat:"option",dataSet:{getData:j,keyField:"id",valField:"name"}},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:g}]}],s={dataFilter:{},formTitle:p+"ROLE_RIGHT",title:p+"ROLE_RIGHTS",icon:"fa-tasks",cols:r,dataPromise:l,add:{handler:h}};return s}]),angular.module("greyscale.tables").factory("greyscaleOrganizationsTbl",["$q","greyscaleUtilsSrv","greyscaleOrganizationApi","greyscaleUserApi","greyscaleProfileSrv","greyscaleModalsSrv","greyscaleRolesSrv","greyscaleGlobals","$rootScope",function(a,b,c,d,e,f,g,h,i){function j(a){var b="adding";return s.dataFilter.formRecord=a,f.editRec(a,s).then(function(d){return d.id?(b="editing",c.update(d,a.realm)):c.add(d,"public")}).then(l)["catch"](function(a){m(a,b)})["finally"](function(){delete s.dataFilter.formRecord})}function k(){var e={orgs:c.list({},"public"),users:d.list({},"public")};return a.all(e).then(function(a){return q.users=a.users,b.prepareFields(a.orgs,r),a.orgs})["catch"](m)}function l(){i.$broadcast(h.events.common.orgUpdate),s.tableParams.reload()}function m(a,c){var d=s.formTitle;c&&(d+=" "+c),d+=" error",b.errorMsg(a,d)}function n(){return!e.isSuperAdmin()&&"both"}function o(b){return b.realm?g(b.realm).then(function(a){var b,c,d=a.length;for(b=0;b<d&&!c;b++)a[b].name===h.userRoles.admin.key&&(c=a[b].id);return c}).then(function(a){var c={roleID:a,field:["id","email","firstName","lastName"]};return d.list(c,b.realm)}):a.resolve([])}var p="ORGANIZATIONS.",q={users:[]},r=[{field:"id",show:!1,title:"ID",dataReadOnly:"both"},{field:"realm",show:!0,
title:"Realm",dataReadOnly:"edit",dataRequired:!0},{field:"name",show:!0,sortable:"name",title:p+"NAME",dataRequired:!0},{field:"address",show:!0,title:p+"ADDRESS"},{field:"url",show:!0,title:p+"SITE_URL"},{field:"enforceApiSecurity",show:!1,dataReadOnly:"both"},{field:"isActive",show:!0,sortable:"isActive",title:p+"IS_ACTIVE",dataFormat:"boolean",dataReadOnly:n},{field:"adminUserId",show:!1,title:p+"ADMIN_USER",dataFormat:"option",dataNoEmptyOption:!0,dataSet:{dataPromise:o,keyField:"id",valField:"email"}},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-pencil",tooltip:"COMMON.EDIT",handler:j}]}],s={formTitle:p+"ORGANIZATION",title:p+"ORGANIZATIONS",icon:"fa-university",cols:r,dataPromise:k,dataFilter:{},add:{handler:j}};return s}]),angular.module("greyscale.tables").factory("greyscaleProductUoasTbl",["$q","_","greyscaleProfileSrv","greyscaleProductApi","greyscaleUoaTypeApi","greyscaleUtilsSrv","greyscaleModalsSrv","greyscaleLanguageApi",function(a,b,c,d,e,f,g,h){function i(){return g.uoasFilter().then(function(a){return a=p(a),q(a)}).then(l)}function j(){return u.dataFilter.productId}function k(){return j()?c.getProfile().then(function(){var b=j(),c={product:d.get(b),uoas:d.product(b).uoasList(),uoaTypes:e.list(),languages:h.list()};return a.all(c).then(function(a){for(var b=0;b<a.uoas.length;b++)f.prepareFields(a.uoas,t);return s.languages=a.languages,s.uoaTypes=a.uoaTypes,s.product=a.product,a.uoas})}):a.reject()}function l(){u.tableParams.reload()}function m(a){var b=j();g.confirm({message:r+"DELETE_CONFIRM",uoa:a,product:s.product,okType:"danger",okText:"COMMON.DELETE"}).then(function(){d.product(b).uoasDel(a.id).then(l)["catch"](function(a){o(a,"deleting")})})}function n(){return s.uoaTypes}function o(a,b){var c=u.formTitle+" "+b+" error";f.errorMsg(a,c)}function p(a){return b.difference(a,u.dataMap)}function q(a){var b=j();return d.product(b).uoasAddBulk(a)}var r="PRODUCTS.UOAS.",s={languages:[],uoaTypes:[]},t=[{field:"name",title:r+"NAME",show:!0,sortable:"name"},{field:"description",title:r+"DESCRIPTION",show:!0,dataFormat:"text"},{field:"shortName",title:r+"SHORT_NAME",show:!0},{field:"unitOfAnalysisType",title:r+"TYPE",show:!0,sortable:"unitOfAnalysisType",dataFormat:"option",dataSet:{getData:n,keyField:"id",valField:"name"}},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:m}]}],u={title:r+"TABLE_TITLE",icon:"fa-table",dataFilter:{},sorting:{id:"asc"},cols:t,dataPromise:k,add:{handler:i}};return u}]),angular.module("greyscale.tables").factory("greyscaleProductWorkflowTbl",["_","$q","greyscaleModalsSrv","greyscaleProductApi","greyscaleUtilsSrv","greyscaleRoleApi","greyscaleProductWorkflowApi","greyscaleGlobals","$timeout","greyscaleGroupApi",function(a,b,c,d,e,f,g,h,i,j){function k(){return h.writeToAnswersList}function l(){return z.dataFilter.workflowId}function m(){return z.dataFilter.product}function n(){return z.dataFilter.organizationId}function o(){var a=l(),c=n(),d={isSystem:!1},e={steps:s(a),roles:f.list(d),groups:j.list(c)};return b.all(e).then(function(a){return w.roles=a.roles,w.groups=a.groups,p(a.steps)})}function p(b){return angular.forEach(b,function(b){b.groups=a.filter(w.groups,function(a){return~b.usergroupId.indexOf(a.id)}),b.writeToAnswers===!0?b.surveyAccess="writeToAnswers":b.writeToAnswers===!1?b.surveyAccess="noWriteToAnswers":(angular.forEach(A,function(a){b.surveyAccess||b[a]!==!0||(b.surveyAccess=a)}),b.surveyAccess||(b.surveyAccess="writeToAnswers"))}),b}function q(){z.tableParams.data.push({groups:[],surveyAccess:"writeToAnswers"}),i(function(){var a=z.el.find("tbody td:not(.expand-row)").last();if(a.length){var b=a.offset().top,c=z.el.closest(".modal");c.length||(c=$(window)),c.scrollTop(b)}})}function r(a){angular.forEach(z.tableParams.data,function(b,c){angular.equals(b,a)&&z.tableParams.data.splice(c,1)})}function s(a){var c=b.when([]);return a&&(c=g.workflow(a).stepsList()),c}function t(){var a=m();return 0!==a.status?v+"SORT_DISABLED":""}function u(){var a=m(),b=0!==a.status?"disabled":"drag-sortable";return b}var v="PRODUCTS.WORKFLOW.STEPS.",w={roles:[]},x={title:{field:"title",show:!0,title:v+"TITLE",dataRequired:!0,dataFormat:"text",showDataInput:!0},role:{field:"role",title:v+"ROLE",showDataInput:!0,show:!0,dataFormat:"text"},startDate:{field:"startDate",title:v+"START_DATE",showDataInput:!0,dataFormat:"date"},endDate:{field:"endDate",title:v+"END_DATE",showDataInput:!0,dataFormat:"date"},writeToAnswers:{field:"writeToAnswers",title:v+"ANSWERS_ACCESS",showDataInput:!0,dataFormat:"option",dataNoEmptyOption:!0,dataSet:{keyField:"value",valField:"name",getData:k}},discussionParticipation:{field:"discussionParticipation",title:v+"DISCUSSION_PARTICIPATION",showDataInput:!0,dataFormat:"boolean"},provideResponses:{field:"provideResponses",title:v+"PROVIDE_RESPONSES",showDataInput:!0,dataFormat:"boolean"},seeOthersResponses:{field:"seeOthersResponses",title:v+"SEE_OTHERS_RESPONSES",showDataInput:!0,dataFormat:"boolean"},allowEdit:{field:"allowEdit",title:v+"ALLOW_EDIT",showDataInput:!0,dataFormat:"boolean"},allowTranslate:{field:"allowTranslate",title:v+"ALLOW_TRANSLATE",showDataInput:!0,dataFormat:"boolean"},blindReview:{field:"blindReview",title:v+"BLIND_REVIEW",showDataInput:!0,dataFormat:"boolean"}},y=[{dataFormat:"action",actions:[{icon:"fa-bars",getTooltip:t,getClass:u}]},{cellTemplateUrl:"views/modals/product-workflow-row-form.html",cellTemplateExtData:{formFields:x,getFreeGroups:function(b){return a.filter(w.groups,function(c){return!a.find(b,{id:c.id})})},stepAddGroup:function(a,b){b&&a.push(b)},stepRemoveGroup:function(a,b){a.splice(b,1)},noFreeGroups:function(a){return a.length===w.groups.length}}},{dataFormat:"action",actions:[{icon:"fa-trash",handler:r}]}],z={title:v+"PRODUCT_WORKFLOW_STEPS",cols:y,dataPromise:o,dragSortable:!0,dataFilter:{},add:{icon:"fa-plus",handler:q}},A=["provideResponses","allowEdit","allowTranslate"];return z}]),angular.module("greyscale.tables").factory("greyscaleUserGroupsTbl",["$q","_","greyscaleGroupApi","greyscaleUtilsSrv",function(a,b,c,d){function e(){var b=j.dataFilter.organizationId;if(!b)return a.reject("400");var d={groups:c.list(b)};return a.all(d).then(function(a){return a.groups}).then(f)["catch"](g)}function f(a){var b=j.dataFilter.selectedIds;return j.multiselect.setSelected(b),a}function g(a,b){var c=j.formTitle;b&&(c+=" "+b),c+=" error",d.errorMsg(a,c)}var h="USERS.GROUPS_MODAL.",i=[{field:"title",show:!0,title:h+"NAME",sortable:"title"},{show:!0,multiselect:!0}],j={dataFilter:{},title:"",cols:i,dataPromise:e,multiselect:{}};return j}]),angular.module("greyscale.tables").factory("greyscaleMyTasksTbl",["_","$q","greyscaleTaskApi",function(a,b,c){function d(){return c.myList().then(function(b){return a.filter(b,function(a){return"current"===a.status})})}var e="MY_TASKS.",f=[{title:e+"TASK",show:!0,cellTemplateUrl:"my-tasks-cell-task.html"},{title:e+"SURVEY",show:!0,cellTemplateUrl:"my-tasks-cell-survey.html"},{title:e+"UOA",show:!0,cellTemplateUrl:"my-tasks-cell-uoa.html"},{field:"startDate",sortable:!0,title:e+"TERMS",show:!0,cellTemplateUrl:"my-tasks-cell-terms.html"},{title:e+"PRODUCT",show:!0,cellTemplateUrl:"my-tasks-cell-product.html"}],g={title:e+"TITLE",icon:"fa-tasks",sorting:{startDate:"asc"},cols:f,dataPromise:d,query:{}};return g}]),angular.module("greyscale.tables").factory("greyscaleMyTasksFutureTbl",["_","$q","greyscaleTaskApi",function(a,b,c){function d(){return c.myList().then(function(b){return a.filter(b,function(a){return!~["current","completed"].indexOf(a.status)})})}var e="MY_TASKS.",f=[{title:e+"TASK",show:!0,cellTemplateUrl:"my-tasks-cell-task.html"},{title:e+"SURVEY",show:!0,cellTemplateUrl:"my-tasks-cell-survey.html"},{title:e+"UOA",show:!0,cellTemplateUrl:"my-tasks-cell-uoa.html"},{field:"startDate",sortable:!0,title:e+"TERMS",show:!0,cellTemplateUrl:"my-tasks-cell-terms.html"},{title:e+"PRODUCT",show:!0,cellTemplateUrl:"my-tasks-cell-product.html"}],g={title:e+"FUTURE_TITLE",icon:"fa-tasks",sorting:{startDate:"asc"},cols:f,dataPromise:d,query:{}};return g}]),angular.module("greyscale.tables").factory("greyscaleMyTasksFineshedTbl",["_","$q","greyscaleTaskApi",function(a,b,c){function d(){return c.myList().then(function(b){return a.filter(b,function(a){return"completed"===a.status})})}var e="MY_TASKS.",f=[{title:e+"TASK",show:!0,cellTemplateUrl:"my-tasks-cell-task.html"},{title:e+"SURVEY",show:!0,cellTemplateUrl:"my-tasks-cell-survey.html"},{title:e+"UOA",show:!0,cellTemplateUrl:"my-tasks-cell-uoa.html"},{field:"startDate",sortable:!0,title:e+"TERMS",show:!0,cellTemplateUrl:"my-tasks-cell-terms.html"},{title:e+"PRODUCT",show:!0,cellTemplateUrl:"my-tasks-cell-product.html"}],g={title:e+"FINISHED_TITLE",icon:"fa-tasks",sorting:{startDate:"asc"},cols:f,dataPromise:d,query:{}};return g}]),angular.module("greyscale.tables").factory("greyscaleUsersImportTbl",function(){var a="IMPORT.USERS.",b=[{field:"email",show:!0,sortable:"email",title:a+"EMAIL"},{field:"firstName",sortable:"firstName",show:!0,title:a+"FIRST_NAME"},{field:"lastName",show:!0,sortable:"lastName",title:a+"LAST_NAME"},{sortable:"message",title:a+"STATUS",cellTemplate:"<div ng-class=\"{'text-danger':(row.parse_status == 'skipped'), 'text-success':(row.parse_status == 'Ok')}\">{{row.message}}<div ng-repeat=\"message in row.messages\">{{message}}</div></div>"}],c={title:a+"RESULTS_TITLE",icon:"fa-upload",cols:b,dataFilter:{}};return c}),angular.module("greyscale.tables").factory("greyscaleGroupsTbl",["$q","_","greyscaleGroupApi","greyscaleModalsSrv","greyscaleUtilsSrv","inform",function(a,b,c,d,e,f){function g(){return o.dataFilter.organizationId}function h(){var b=g();if(b){var d={groups:c.list(b)};return a.all(d).then(function(a){return a.groups})}return a.reject()}function i(a){var b="editing";d.editRec(a,o).then(function(a){if(a.id)return c.update(a);b="adding";var d=g();return c.add(d,a)}).then(k)["catch"](function(a){return l(a,b)})}function j(a){d.confirm({message:m+"DELETE_CONFIRM",group:a,okType:"danger",okText:"COMMON.DELETE"}).then(function(){c["delete"](a.id).then(k)["catch"](function(a){l(a,"deleting")})})}function k(){o.tableParams.reload()}function l(a,b){var c=o.formTitle+" "+b+" error";e.errorMsg(a,c)}var m="USER_GROUPS.",n=[{field:"id",title:"ID",show:!1,sortable:"id",dataReadOnly:"both"},{field:"title",title:m+"NAME",show:!0,sortable:"title",dataRequired:!0},{show:!0,dataFormat:"action",actions:[{icon:"fa-pencil",tooltip:"COMMON.EDIT",handler:i},{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:j}]}],o={title:"",cols:n,sorting:{id:"asc"},dataPromise:h,dataFilter:{},formTitle:m+"USER_GROUP",add:{handler:i}};return o}]),angular.module("greyscale.tables").factory("greyscaleProductTasksTbl",["_","$q","$sce","greyscaleProductApi","greyscaleProductWorkflowApi","greyscaleUserApi","greyscaleGroupApi","greyscaleModalsSrv",function(a,b,c,d,e,f,g,h){function i(){return t.dataFilter.productId}function j(){var a=i();return a?d.get(a).then(k):b.reject()}function k(a){if(!a.workflow)return b.when([]);var c={users:f.list(),uoas:d.product(a.id).uoasList(),tasks:d.product(a.id).tasksList(),steps:e.workflow(a.workflow.id).stepsList()};return b.all(c).then(function(b){return angular.extend(r,{product:a,uoas:b.uoas,users:b.users,steps:b.steps,tasks:b.tasks,groups:[]}),l(b.tasks).then(m)})}function l(c){var d,e;return angular.forEach(c,function(b){if(b.uoa=a.find(r.uoas,{id:b.uoaId}),b.step=a.find(r.steps,{id:b.stepId}),b.users=[],b.userIds)for(e=b.userIds.length,d=0;d<e;d++)b.users.push(a.find(r.users,{id:b.userIds[d]}));if(b.groups=[],b.groupIds)for(e=b.groupIds.length,d=0;d<e;d++)b.groups.push(a.find(r.groups,{id:b.userIds[d]}));b.userIds&&b.userIds.length&&(b.user=a.find(r.users,{id:b.userIds[0]}))}),t.dataShare.tasks=c,b.when(c)}function m(c){var d=[],e=a.groupBy(c,"uoaId");return angular.forEach(e,function(b){b=a.sortBy(b,"position");var c;angular.forEach(b,function(a){!c&&a.uoa&&a.stepId===a.uoa.currentStepId&&(c=a)}),c||(c=b[0],c.noActiveTask=!0),0===r.product.status&&(c.planningMode=!0),c=n(c,b),d.push(c)}),b.when(d)}function n(b,c){b.progress=[];var d,e,f=(parseInt(b.id),0);angular.forEach(a.sortBy(r.steps,"position"),function(g){var h=a.find(c,{stepId:g.id});h||(h={step:g}),h.flagClass="",d&&h.id===d&&(h.flagClass="backward",h.flaggedto=e,h.flaggedfrom=d,d=null),h.flagged&&"completed"!==h.status&&(h.flagClass=h.flagClass||"flag",d=b.flaggedfrom,e=b.id);var i=a.pick(h,["id","status","active","flagged","step","user","endDate","startDate","flaggedcount","flagClass","flaggedfrom","flaggedto","planningMode"]);"completed"!==b.status&&f++,b.uoa.currentStepId===i.step.id&&(i.active=!0,b.activeStep=i.step,b.onTime=o(i)),i.onTime=b.onTime,i.active&&i.flaggedfrom&&(b.onTime=i.onTime=o(a.find(c,{id:i.flaggedfrom}))),b.progress.push(i)}),(b.planningMode||!f&&!b.noActiveTask)&&(b.allCompleted=!f,a.map(b.progress,function(a){"completed"!==a.status&&(a.status="waiting"),a.active=!1})),b.progress=a.sortBy(b.progress,"step.position");for(var g=b.progress.length-1;g>=0;g--)if(b.progress[g].id){b.last=b.progress[g].id===b.id;break}return"completed"===b.progress[b.progress.length-1].status&&(b.subjectCompleted=!0),b.started=!!b.lastVersionDate,b}function o(a){return new Date(a.endDate).setHours(23,59,59,999)>=new Date}function p(a){if(a.deadlineInfo)return a.deadlineInfo;var b={};return angular.forEach(a.progress,function(a){a.endDate&&(b.endDate=a.endDate)}),b.isOverdue=!o(b),a.deadlineInfo=b,b}var q="PRODUCT_TASKS.",r={uoas:[],users:[],steps:[],tasks:[],groups:[]},s=[{title:q+"UOA",field:"uoa.name",sortable:"uoa.name"},{title:q+"PROGRESS",cellClass:"text-center",cellTemplate:'<span class="progress-blocks"><span class="progress-block status-{{item.status}}" popover-trigger="mouseenter" uib-popover-template="item.user && \'views/controllers/pm-dashboard-product-tasks-progress-popover.html\'" ng-class="{active:item.active, delayed: !item.onTime}" ng-repeat="item in row.progress track by $index"><i ng-show="!item.user && item.active" class="text-danger fa fa-exclamation"></i><i ng-show="item.flagClass" class="fa fa-{{item.flagClass}}"></i><span class="counter" ng-show="item.flagged && item.status != \'completed\'">{{item.flaggedcount}}</span></span></span>'},{title:q+"DEADLINE",sortable:"endDate",cellTemplate:"<span ng-class=\"{'text-danger': ext.deadline(row).isOverdue }\">{{ext.deadline(row).endDate|date}}</span>",cellTemplateExtData:{deadline:p}},{title:q+"LAST_UPDATE",field:"lastVersionDate",sortable:"lastVersionDate",cellTemplate:"{{cell|date:'short'}}"},{show:!0,titleTemplate:'<div class="text-right"><a class="action expand-all"><i class="fa fa-eye"></i></a></div>',cellTemplate:'<div class="text-right" ng-if="!row.subjectCompleted"><a class="action"><i class="fa fa-eye"></i></a></div><div class="text-right" ng-if="row.subjectCompleted" title="{{\''+q+'UOA_TASKS_COMPLETED\'|translate}}"><i class="fa fa-check text-success"></i></div>'}],t={title:q+"TITLE",icon:"fa-tasks",cols:s,dataFilter:{},dataShare:{},sorting:{"uoa.name":"asc","step.position":"asc"},classes:"table-hover",rowClass:"action-expand-row",dataPromise:j};return t}]),angular.module("greyscale.tables").factory("greyscaleNotificationsTbl",["$q","_","$sce","greyscaleProfileSrv","greyscaleGroupApi","greyscaleNotificationApi","greyscaleModalsSrv","userNotificationsSrv","greyscaleGlobals","Organization",function(a,b,c,d,e,f,g,h,i,j){function k(){return d.getProfile().then(l).then(function(b){var c={notifications:f.list({userTo:b.id},o)};return a.all(c).then(function(a){return a.notifications})})}function l(a){return o=d.isSuperAdmin()?i.adminSchema:j.realm,a}function m(a){var b=a.read?"setUnread":"setRead";f[b](a.id,o).then(function(){a.read=!a.read,h.update()})}function n(a){m(a);var b={id:a.userFrom,replyTo:a.userFromName};g.sendMessage(b)}var o,p="NOTIFICATIONS.",q=[{field:"created",title:p+"DATE_TIME",cellTemplate:"<small>{{cell|date:'medium'}}</small>",sortable:"created"},{title:p+"USER",field:"userFromName",sortable:"userFromName"},{cellTemplate:'<span ng-if="row.toMe"><i class="fa fa-chevron-right"></i></span><span ng-if="row.fromMe"><i class="fa fa-chevron-left"></i></span>'},{field:"body",title:p+"MESSAGE",cellTemplate:'<p><b>{{row.subject}}</b><br><span ng-bind-html="ext.sanitize(row.note)"></span></p>',cellTemplateExtData:{sanitize:c.trustAsHtml}},{field:"read",title:p+"READ",sortable:"read",cellTemplate:'<div class="text-center"><i class="fa" ng-class="{\'fa-eye\':row.read, \'fa-eye-slash\':!row.read}" title="{{\''+p+'\' + (row.read ? \'WAS_READ\' : \'WAS_NOT_READ\')|translate}}"></i>&nbsp;<a ng-click="ext.toggleRead(row)" class="action" ><small ng-show="row.read" translate="'+p+'SET_UNREAD"></small><small ng-hide="row.read" translate="'+p+'SET_READ"></small></a></div>',cellTemplateExtData:{toggleRead:m}},{cellTemplate:'<div class="text-right"><a ng-if="row.toMe" class="action" ng-click="ext.reply(row)" title="{{\''+p+'REPLY\'|translate}}"><i class="fa fa-reply"></i></a></div>',cellTemplateExtData:{reply:n}}],r={title:p+"NOTIFICATIONS",cols:q,sorting:{created:"desc"},dataPromise:k,dataFilter:{},pageLength:50,rowClass:function(a){return a.read?"":"bg-warning"}};return r}]),angular.module("greyscale.tables").factory("greyscaleSuperusersTbl",["_","$q","greyscaleModalsSrv","greyscaleUserApi","greyscaleGroupApi","greyscaleUtilsSrv","greyscaleProfileSrv","greyscaleGlobals","greyscaleRoleApi","i18n","greyscaleNotificationApi","inform",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(a){c.confirm({message:x+"DELETE_CONFIRM",user:a,okType:"danger",okText:"COMMON.DELETE"}).then(function(){d["delete"](a.id,y).then(s)["catch"](function(a){v(a,"deleting")})})}function n(a){return a.id!==z.profile.id}function o(a){c.sendNotification(a)}function p(a){c.changePassword(a,y)}function q(a){var b="adding";return c.editRec(a,B).then(function(a){return a.password&&delete a.password,a.id?(b="editing",d.update(a,y)):d.inviteSuperAdmin(a)}).then(s)["catch"](function(a){v(a,b)})}function r(a){k.resendUserInvite(a.id,y).then(function(){l.add(j.translate(x+"RESEND_ACTIVATION_DONE"),{type:"success"})})["catch"](function(a){f.errorMsg(a,"Resend Activation")})}function s(){B.tableParams.reload()}function t(){return h.notifyLevels}function u(){return g.getProfile().then(function(a){z.profile=a;var c={users:d.list({},y)};return b.all(c).then(function(a){return f.prepareFields(a.users,A),a.users})})["catch"](v)}function v(a,b){var c=B.formTitle;b&&(c+=" "+b),c+=" error",f.errorMsg(a,c)}function w(){return!!B.profileMode}var x="USERS.",y=h.adminSchema,z={},A=[{field:"id",title:"ID",show:!1,sortable:"id",dataReadOnly:"both",dataHide:w},{field:"email",title:x+"EMAIL",show:!1,sortable:"email",dataRequired:!0},{field:"firstName",title:x+"FIRST_NAME",show:!0,sortable:"firstName",dataRequired:!0},{field:"lastName",title:x+"LAST_NAME",show:!0,sortable:"lastName"},{field:"lastActive",title:x+"LAST_ACTIVE",show:!0,sortable:"lastActive",dataReadOnly:"both",cellTemplate:'<span ng-hide="cell" translate="USERS.NOT_LOGGED"></span>{{cell|date:\'medium\'}}'},{field:"isActive",title:x+"IS_ACTIVE",show:!0,sortable:"isActive",dataFormat:"boolean",dataReadOnly:"new"},{field:"isAnonymous",title:x+"ANONYMOUS",show:!0,sortable:"isAnonymous",dataFormat:"boolean"},{title:"",show:!1,dataHide:!0,cellTemplate:'<span ng-show="!row.isActive"><a ng-click="ext.resendActivation(row)" class="btn btn-primary" translate="'+x+'RESEND_ACTIVATION"></a></span>',cellTemplateExtData:{resendActivation:r}},{title:"COMMON.SEND_MESSAGE",viewHide:!0,cellTemplate:'<div class="text-center">   <a ng-click="ext.sendMessageTo(row); $event.stopPropagation()" class="action">       <i ng-if="ext.anotherUser(row)" class="fa fa-envelope"></i>   </a></div>',dataHide:!0,cellTemplateExtData:{anotherUser:n,sendMessageTo:o}},{field:"notifyLevel",title:x+"NOTIFY_LEVEL",dataFormat:"option",cellTemplate:'<div class="text-center">       {{cell}}   </div>',dataNoEmptyOption:!0,dataSet:{getData:t,keyField:"value",valField:"name"}},{field:"",title:"",show:!0,dataFormat:"action",actions:[{icon:"fa-pencil",tooltip:"COMMON.EDIT",handler:q},{icon:"fa-lock",tooltip:x+"CHANGE_PASSWORD",handler:p},{icon:"fa-trash",tooltip:"COMMON.DELETE",handler:m}]}],B={dataFilter:{},formTitle:x+"USER",cols:A,dataPromise:u,selectable:!0,sorting:{created:"desc"},add:{handler:q}};return B}]);